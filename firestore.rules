rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Any authenticated user can read a user doc (needed for friend profiles / passports).
    // Only the owner can do a full write.
    // Exception: any authenticated user may append their own UID to another user's friendIds
    // (the "mutual friend add" flow â€” scanning a QR code).
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['friendIds'])
        && request.resource.data.friendIds.hasAll(resource.data.get('friendIds', []))
        && request.resource.data.friendIds.size() == resource.data.get('friendIds', []).size() + 1
        && request.auth.uid in request.resource.data.friendIds;
    }

    // Pints are readable by the owner OR by any of the owner's friends.
    match /pints/{pintId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        request.auth.uid in get(/databases/$(database)/documents/users/$(resource.data.userId)).data.get('friendIds', [])
      );
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}
